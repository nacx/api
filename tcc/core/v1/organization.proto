// Copyright (c) Tetrate, Inc 2019 All Rights Reserved.

syntax = "proto3";

package tetrate.api.tcc.core.v1;
option go_package = "github.com/tetrateio/tetrate/api/tcc/core/v1";

import "google/api/annotations.proto";
import "google/protobuf/empty.proto";
import "validate/validate.proto";

import "permissions.proto";
import "rbac.proto";

import "gogoproto/gogo.proto";

// Enable generation of XXX_MessageName methods for grpc-go/status.
option (gogoproto.messagename_all) = true;

service Organization {
  option (tetrate.api.q.rbac.v1.default_requires) = {
    permissions: READ
  };

  rpc CreateTenant(CreateTenantRequest) returns (Tenant) {
    option (tetrate.api.q.rbac.v1.requires) = {
      permissions: CREATE
    };
    option (google.api.http) = {
      post: "/v1/tenants"
      body: "*"
    };
  };

  rpc GetTenant(GetTenantRequest) returns (Tenant) {
    option (google.api.http) = {
      get: "/v1/tenants/{id}"
    };
  };

  rpc UpdateTenant(Tenant) returns (Tenant) {
    option (tetrate.api.q.rbac.v1.requires) = {
      permissions: WRITE
    };
    option (google.api.http) = {
      put: "/v1/tenants/{id}"
      body: "*"
    };
  };

  rpc ListTenants(ListTenantsRequest) returns (ListTenantsResponse) {
    option (google.api.http) = {
      get: "/v1/tenants"
    };
  }

  rpc DeleteTenant(DeleteTenantRequest) returns (google.protobuf.Empty) {
    option (tetrate.api.q.rbac.v1.requires) = {
      permissions: DELETE
    };
    option (google.api.http) = {
      delete: "/v1/tenants/{id}"
    };
  };

  rpc GetTenantPolicy(GetTenantRequest) returns (tetrate.api.q.rbac.v1.Policy) {
    option (tetrate.api.q.rbac.v1.requires) = {
      permissions: SET_POLICY
    };
    option (google.api.http) = {
      get: "/v1/tenants/{id}/policy"
    };
  };

  rpc SetTenantPolicy(TenantPolicyRequest) returns (google.protobuf.Empty) {
    option (tetrate.api.q.rbac.v1.requires) = {
      permissions: SET_POLICY
    };
    option (google.api.http) = {
      put: "/v1/tenants/{id}/policy"
      body: "policy"
    };
  };

  // SyncTenant is used by processes that monitor the identity providers to synchronize
  // the users and teams with the ones in TCC
  rpc SyncTenant(SyncTenantRequest) returns (SyncTenantResponse) {
    option (tetrate.api.q.rbac.v1.requires) = {
      raw_permissions: ["CreateUser", "CreateTeam", "DeleteUser", "DeleteTeam", "WriteTeam"]
    };
    option (google.api.http) = {
      post: "/v1/tenants/{id}/sync"
      body: "*"
    };
  };

  rpc CreateTeam(CreateTeamRequest) returns (Team) {
    option (tetrate.api.q.rbac.v1.requires) = {
      permissions: CREATE
    };
    option (google.api.http) = {
      post: "/v1/tenants/{tenant}/teams"
      body: "*"
    };
  };

  rpc UpdateTeam(Team) returns (Team) {
    option (tetrate.api.q.rbac.v1.requires) = {
      permissions: WRITE
    };
    option (google.api.http) = {
      put: "/v1/tenants/{tenant}/teams/{id}"
      body: "*"
    };
  };

  rpc GetTeam(GetTeamRequest) returns (Team) {
    option (google.api.http) = {
      get: "/v1/tenants/{tenant}/teams/{id}"
    };
  };

  rpc ListTeams(ListTeamsRequest) returns (ListTeamsResponse) {
    option (google.api.http) = {
      get: "/v1/tenants/{tenant}/teams"
    };
  }

  rpc DeleteTeam(DeleteTeamRequest) returns (google.protobuf.Empty) {
    option (tetrate.api.q.rbac.v1.requires) = {
      permissions: DELETE
    };
    option (google.api.http) = {
      delete: "/v1/tenants/{tenant}/teams/{id}"
    };
  };

  rpc CreateUser(CreateUserRequest) returns (User) {
    option (tetrate.api.q.rbac.v1.requires) = {
      permissions: CREATE
    };
    option (google.api.http) = {
      post: "/v1/tenants/{tenant}/users"
      body: "*"
    };
  };

  rpc GetUser(GetUserRequest) returns (User) {
    option (google.api.http) = {
      get: "/v1/tenants/{tenant}/users/{id}"
    };
  };

  rpc UpdateUser(User) returns (User) {
    option (tetrate.api.q.rbac.v1.requires) = {
      permissions: WRITE
    };
    option (google.api.http) = {
      put: "/v1/tenants/{tenant}/users/{id}"
      body: "*"
    };
  };

  rpc DeleteUser(DeleteUserRequest) returns (google.protobuf.Empty) {
    option (tetrate.api.q.rbac.v1.requires) = {
      permissions: DELETE
    };
    option (google.api.http) = {
      delete: "/v1/tenants/{tenant}/users/{id}"
    };
  };

  rpc ListUsers(ListUsersRequest) returns (ListUsersResponse) {
    option (google.api.http) = {
      get: "/v1/tenants/{tenant}/users"
    };
  };
}

message Tenant {
  // Internal use only. Auto populated field.
  string name = 1;
  string id = 2 [(validate.rules).string.min_len = 1];
  string description = 3;
}

message CreateTenantRequest {
  string id = 1;

  string description = 3;
}

message GetTenantRequest {
  // Internal use only. Auto populated field.
  string name = 1;
  string id = 2 [(validate.rules).string.min_len = 1];
}

message TenantPolicyRequest {
  // Internal use only. Auto populated field.
  string name = 1;
  string id = 2 [(validate.rules).string.min_len = 1];
  tetrate.api.q.rbac.v1.Policy policy = 3 [(validate.rules).message.required = true];
}

message ListTenantsRequest {
}

message ListTenantsResponse {
  repeated Tenant tenants = 1;
}

message DeleteTenantRequest {
  // Internal use only. Auto populated field.
  string name = 1;
  string id = 2 [(validate.rules).string.min_len = 1];
}

// SourceType describes where users and teams come from
enum SourceType {
  INVALID = 0;
  // LDAP is used for users and teams that are automatically synchronized from LDAP
  LDAP = 1;
  // LOCAL is used for users and teams that are manually created using the TCC API and that
  // are local to TCC.
  // TODO(nacx): Users represent subjects that can be authenticated against an external identity
  // Provider
  // so it is unlikely that there will be local users. Instead of having local users, we should
  // introduce the
  // local service account concept as a proper entity in the model, and configure all TCC agents and
  // the superuser
  // as local service accounts.
  LOCAL = 2;
}

message SyncTenantRequest {
  // Internal use only. Auto populated field.
  string name = 1;
  string id = 2 [(validate.rules).string.min_len = 1];

  SourceType source_type = 3 [(validate.rules).enum.defined_only = true];

  // Information of a user as synchronized from the team source. This differs slightly from a TCC
  // user since
  // the fields here are raw info that does not have the context of the TCC hierarchy.
  message SyncUser {
    string id = 1 [(validate.rules).string.min_len = 1];
    string description = 4;
  };
  repeated SyncUser users = 4;

  // Information of a team as synchronized from the team source. This differs slightly from a TCC
  // user since
  // the fields here are raw info that does not have the context of the TCC hierarchy.
  message SyncTeam {
    string id = 1 [(validate.rules).string.min_len = 1];
    string description = 2;
    repeated string member_user_ids = 3;
    repeated string member_group_ids = 4;
  };
  repeated SyncTeam teams = 5;
}

message SyncTenantResponse {
  message FailedIds {
    repeated string removal = 1;
    repeated string addition = 2;
    repeated string update = 3;
  }

  FailedIds failed_users = 1;
  FailedIds failed_teams = 2;
}

message Team {
  // Internal use only. Auto populated field.
  string name = 1;
  string tenant = 2 [(validate.rules).string.min_len = 1];
  string id = 3 [(validate.rules).string.min_len = 1];
  string description = 4;
  repeated string members = 5;
  string etag = 6 [(validate.rules).string.min_len = 1];
  SourceType source_type = 7 [(validate.rules).enum.defined_only = true];
}

message CreateTeamRequest {
  // Internal use only. Auto populated field.
  string parent = 1;
  // Tenant.Id.
  string tenant = 2 [(validate.rules).string.min_len = 1];
  // If present, this will be used as the id for the created object.
  string id = 3;

  string description = 4;
  repeated string members = 5;
  SourceType source_type = 6 [(validate.rules).enum.defined_only = true];
}

message GetTeamRequest {
  // Internal use only. Auto populated field.
  string name = 1;
  string tenant = 2 [(validate.rules).string.min_len = 1];
  string id = 3 [(validate.rules).string.min_len = 1];
}

message ListTeamsRequest {
  // Internal use only. Auto populated field.
  string parent = 1;
  string tenant = 2 [(validate.rules).string.min_len = 1];
}

message ListTeamsResponse {
  repeated Team teams = 1;
}

message DeleteTeamRequest {
  // Internal use only. Auto populated field.
  string name = 1;
  string tenant = 2 [(validate.rules).string.min_len = 1];
  string id = 3 [(validate.rules).string.min_len = 1];
}

message User {
  // Internal use only. Auto populated field.
  string name = 1;
  string tenant = 2 [(validate.rules).string.min_len = 1];
  string id = 3 [(validate.rules).string.min_len = 1];
  string description = 4;
  SourceType source_type = 7 [(validate.rules).enum.defined_only = true];
}

message CreateUserRequest {
  // Internal use only. Auto populated field.
  string parent = 1;
  // Tenant.Id.
  string tenant = 2 [(validate.rules).string.min_len = 1];
  // If present, this will be used as the id for the created object.
  string id = 3;

  string description = 4;
  SourceType source_type = 5 [(validate.rules).enum.defined_only = true];
}

message GetUserRequest {
  // Internal use only. Auto populated field.
  string name = 1;
  string tenant = 2 [(validate.rules).string.min_len = 1];
  string id = 3 [(validate.rules).string.min_len = 1];
}

message ListUsersRequest {
  // Internal use only. Auto populated field.
  string parent = 1;
  string tenant = 2 [(validate.rules).string.min_len = 1];
}

message ListUsersResponse {
  repeated User users = 1;
}

message DeleteUserRequest {
  // Internal use only. Auto populated field.
  string name = 1;
  string tenant = 2 [(validate.rules).string.min_len = 1];
  string id = 3 [(validate.rules).string.min_len = 1];
}
